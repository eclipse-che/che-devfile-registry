name: Update base images
on:
  workflow_dispatch:
    inputs:
      params:
        description: 'Additional parameters to updateBaseImages.sh'
        default: ''
        required: false
      branch:
        description: 'Project branch'
        default: 'master'
        required: true

jobs:
  build:
    name: Check if base images in Dockerfiles can be updated to newer tags
    runs-on: ubuntu-20.04
    steps:
      - name: "Checkout source code"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Login to registry.redhat.io 
        uses: docker/login-action@v1
        with:
          registry: registry.redhat.io
          username: ${{ secrets.CRW_BUILD_USER }}
          password: ${{ secrets.CRW_BUILD_TOKEN }}
      - name: Install skopeo
        run: |
          . /etc/os-release
          echo "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/ /" | sudo tee /etc/apt/sources.list.d/devel:kubic:libcontainers:stable.list
          curl -L https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/xUbuntu_${VERSION_ID}/Release.key | sudo apt-key add -
          sudo apt-get update
          sudo apt-get -y upgrade
          sudo apt-get -y install skopeo
      - name: Get + run base image check
        run: |
          pushd /tmp >/dev/null || exit 1
          curl -sSLO https://raw.githubusercontent.com/redhat-developer/codeready-workspaces/crw-2-rhel-8/product/updateBaseImages.sh && \
          chmod +x updateBaseImages.sh
          popd >/dev/null || exit 1
          git config --global user.name "Mykhailo Kuznietsov"
          git config --global user.email "mkuznets@redhat.com"
          export GITHUB_TOKEN=${CHE_BOT_GITHUB_TOKEN}
          /tmp/updateBaseImages.sh -b ${{ github.event.inputs.branch }} -maxdepth 3 -f *Dockerfile ${{ github.event.inputs.params }}
